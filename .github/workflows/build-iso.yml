name: Build Bootable ISO

on:
  workflow_dispatch:

jobs:
  iso:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build bootable ISO
        run: bash installer/scripts/build-iso-linux.sh
      - name: Fix permissions for artifacts
        if: always()
        run: sudo chown -R $USER:$USER installer/live/work || true
      - name: Create log bundle
        if: always()
        run: |
          mkdir -p /tmp/iso-logs
          cp -f installer/live/work/lb-build.log /tmp/iso-logs/ 2>/dev/null || true
          cp -f installer/live/work/config/bootstrap /tmp/iso-logs/ 2>/dev/null || true
          cp -f installer/live/work/config/common /tmp/iso-logs/ 2>/dev/null || true
          tar -czf /tmp/windows12-iso-logs.tgz -C /tmp iso-logs
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows12-style-os-iso
          path: installer/live/work/live-image-amd64.hybrid.iso
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows12-style-os-iso-logs
          path: /tmp/windows12-iso-logs.tgz
