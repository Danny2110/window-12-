name: Build Bootable ISO

on:
  workflow_dispatch:

jobs:
  iso:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends curl ca-certificates build-essential git xz-utils
      - name: Install Rust toolchain
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs -o /tmp/rustup-init.sh
          sh /tmp/rustup-init.sh -y --profile minimal --default-toolchain stable
          . "$HOME/.cargo/env"
          rustc --version
          cargo --version
      - name: Build bootable ISO
        run: |
          . "$HOME/.cargo/env"
          bash installer/scripts/build-iso-linux.sh
      - name: Fix permissions for artifacts
        if: always()
        run: chmod -R a+rX installer/live/work || true
      - name: Create log bundle
        if: always()
        run: |
          mkdir -p /tmp/iso-logs
          cp -f installer/live/work/lb-build.log /tmp/iso-logs/ 2>/dev/null || true
          cp -f installer/live/work/config/bootstrap /tmp/iso-logs/ 2>/dev/null || true
          cp -f installer/live/work/config/common /tmp/iso-logs/ 2>/dev/null || true
          tar -czf /tmp/windows12-iso-logs.tgz -C /tmp iso-logs
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows12-style-os-iso
          path: installer/live/work/live-image-amd64.hybrid.iso
      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows12-style-os-iso-logs
          path: /tmp/windows12-iso-logs.tgz
